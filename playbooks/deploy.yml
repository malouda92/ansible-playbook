---
- name: Déploiement de l'application JAR depuis Artifactory
  hosts: app-server
  become: true
  become_method: sudo
  become_user: root

  vars:
    deploy_dir: "/opt/myapp"
    java_path: "/usr/bin/java"

  tasks:
    - name:
      ansible.builtin.include_role:
        name: download_jar

    - name: Créer le répertoire de déploiement
      file:
        path: "{{ deploy_dir }}"
        state: directory
        mode: '0755'

    - name: Copier le JAR dans le répertoire de déploiement
      ansible.builtin.copy:
        src: "/tmp/{{ artefact_filename }}"
        dest: "{{ deploy_dir }}/{{ artefact_filename }}"
        owner: ansible
        mode: '0755'
        remote_src: true

    - name: Suppression du fichier dans tmp
      ansible.builtin.file:
        path: "/tmp/{{ artefact_filename }}"
        state: absent

    - name: Créer le fichier de service systemd
      ansible.builtin.include_role:
        name: appmgr

